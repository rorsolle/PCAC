clear; close all;

%% Load parameters and model
%Example_S_5
%Example_S_6
Example_1
%Example_2

params.sys_params = sys_params;
params.rls_params = rls_params;
params.pcac_params = pcac_params;

nb_sample = 100;

%% Data to store
Y = zeros(n_y,nb_sample);
U = zeros(n_u,nb_sample);

nb_var = n_est*n_y*(n_u+n_y)+n_u*n_y; %Size of theta
Theta = zeros(nb_var,nb_sample+1);
Theta(:,1) = Theta_0.*ones(nb_var,1);
P = zeros(nb_var,nb_var,nb_sample+1);
P(:,:,1) = P_0.*eye(nb_var,nb_var);

%% Compute the theta reference
[num,den] = tfdata(G);
num = num{1};den = den{1};
theta_ref = [-den(end:-1:2),num]';

%% Noise
W = randn(n_u,nb_sample)*std_w;
V = randn(n_y,nb_sample)*std_v;

t = 0:1:nb_sample-1;

%% PCAC + RLS
for k=1:nb_sample-1
    if k>n_est
    u_pcac = pcac(k, Y, U, Theta(:,k), params); %PCAC
    U(:,k+1) = u_pcac;
    end
    Y = lsim(G,(U+W)',t)'; %System reponse
    [Theta,P] = rls_code(k, Y + V, U, P, Theta, params); %RLS
end

%% Plot

% Theta
figure(1)
sqrt_nb_var = ceil(sqrt(nb_var));
for k=1:nb_var
subplot(sqrt_nb_var,ceil(nb_var/sqrt_nb_var),k)
plot(Theta(k,:))
%loglog(abs(Theta(k,:) - theta_ref(k))')
end

% Input Output
figure(2)
ax1 = subplot(6,1,1);
stairs(t,Y)
hold on
stairs(t,sys_params.ref(t),"--k")
ylabel("Output")
set(gca,'XTickLabel',[])

ax2 = subplot(6,1,2);
stairs(t,U)
hold on
stairs(t,ones(size(t))*pcac_params.u_min,"--k")
stairs(t,ones(size(t))*pcac_params.u_max,"--k")
ylabel("Input")
set(gca,'XTickLabel',[])

ax3 = subplot(6,1,3);
stairs(t,log(abs(sys_params.C_t*Y - sys_params.ref(t))))
ylabel("log|y_k - r_k|")
set(gca,'XTickLabel',[])

% Impulse response and DC
length_impulse = 100;
u_impulse = zeros(sys_params.n_u,length_impulse);
u_impulse(:,1) = 1;
y_impulse = lsim(G,u_impulse',0:length_impulse-1)';
Delta_IR = zeros(1,nb_sample);
Delta_DC = zeros(1,nb_sample);
[num,den] = tfdata(G);
DC = sum(num{1})/sum(den{1});
for k=1:nb_sample
G_hat = tf(Theta(n_est+1:end,k)',[1;Theta(1:n_est,k)]',1);
y_hat_impulse = lsim(G_hat,u_impulse',0:length_impulse-1)';
Delta_IR(k) = norm(y_hat_impulse - y_impulse);
DC_hat = sum(Theta(n_est+1:end,k))/sum(Theta(1:n_est,k));
Delta_DC(k) = abs(DC_hat - DC);
end

ax4 = subplot(6,1,4);
stairs(t,log(Delta_IR))
ylabel("log||\Delta IR||")
set(gca,'XTickLabel',[])

ax5 = subplot(6,1,5);
stairs(t,log(Delta_DC))
xlabel("k (step)")
ylabel("log||\Delta DC||")
set(gca,'XTickLabel',[])

linkaxes([ax1,ax2,ax3,ax4,ax5],'x')
p1 = get(ax1, 'Position');
p2 = get(ax2, 'Position');
p3 = get(ax3, 'Position');
p4 = get(ax4, 'Position');
p5 = get(ax5, 'Position');
p4(2) = p5(2)+p5(4);
p1(2) = p2(2)+p2(4);
p2(2) = p3(2)+p3(4);



subplot(6,1,6)
pzmap(G)
hold on
pzmap(G_hat)